<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkÄ±llÄ± Yoklama Sistemi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    
    <style>
        /* Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Arka Plan IÅŸÄ±k Animasyonu */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 { animation-delay: -2s; }
        .animation-delay-4000 { animation-delay: -4s; }

        /* Oturum kapalÄ±yken QR alanÄ± iÃ§in yumuÅŸak geÃ§iÅŸ */
        .qr-placeholder {
            transition: all 0.3s ease-in-out;
        }

        /* Sayfa yÃ¼klendiÄŸinde iÃ§eriÄŸin yumuÅŸak gÃ¶rÃ¼nmesi iÃ§in */
        .fade-in {
            animation: fadeInAnimation 0.5s ease-in-out;
        }
        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-[#0d1117] text-gray-200">

    <div id="app-container"></div>

    <script type="module">
        // --- KÃœTÃœPHANE YARDIMCILARI ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- UYGULAMA MANTIÄI (React olmadan, saf JavaScript ile) ---
        const BACKEND = {
            mode: 'LOCAL',
            APPS_SCRIPT_URL: ''
        };
        const ls = {
            get(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } },
            set(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch { } },
        };
        const api = {
            async saveSession(week, session) { if (BACKEND.mode === 'LOCAL') { const s = ls.get('ys_sessions', {}); s[week] = session; ls.set('ys_sessions', s); return session; } /* DiÄŸer modlar iÃ§in kod buraya eklenebilir */ },
            async getSession(week) { if (BACKEND.mode === 'LOCAL') { const s = ls.get('ys_sessions', {}); return s[week] || null; } },
            async recordCheckin(week, number, code) { if (BACKEND.mode === 'LOCAL') { const s = ls.get('ys_sessions', {}); const sess = s[week]; if (!sess?.active) throw new Error('Oturum aktif deÄŸil.'); if (String(sess.code).trim() !== String(code).trim()) throw new Error('Kod doÄŸrulanamadÄ±.'); const a = ls.get('ys_attendance', {}); const c = new Set(a[week] || []); if (c.has(number)) throw new Error('Bu numara zaten yoklamaya katÄ±ldÄ±.'); c.add(number); a[week] = Array.from(c); ls.set('ys_attendance', a); return { ok: true }; } },
        };

        // --- UYGULAMA DURUMU (STATE) ---
        let state = {
            students: ls.get('ys_students', [
                { id: 1, name: 'Ä°BRAHÄ°M GÃœLTEKÄ°N', number: '18070003013' }, { id: 2, name: 'ELÄ°F EMÄ°NE GÃœNAL', number: '19070001053' }, { id: 3, name: 'ERK YANKI URAL', number: '19070008012' }, { id: 4, name: 'ERCE Ã–ZKAN', number: '20070001057' }, { id: 5, name: 'Ä°PEK ATIÅ', number: '20070002048' }, { id: 6, name: 'Ä°DÄ°L ECE CEVAHÄ°R', number: '20070007004' }, { id: 7, name: 'SUDE ONFÄ°DAN', number: '20070008016' }, { id: 8, name: 'Ã–MER ARICA', number: '20070008017' }, { id: 9, name: 'SELÄ°M MERT KIRCAALÄ°LÄ°', number: '20070008019' }, { id: 10, name: 'BERÄ°L DERAN GÃœRBÃœZ', number: '20070008029' }, { id: 11, name: 'ALÄ° HAKTAN SIÄIN', number: '21070001004' }, { id: 12, name: 'ARDA ALTUNHAN', number: '21070001051' }, { id: 13, name: 'EKREM TEMEL', number: '21070001070' }, { id: 14, name: 'NESRÄ°N ÅENTÃœRK', number: '21070002005' }, { id: 15, name: 'BATUHAN ÅÄ°ÅMAN', number: '21070002025' }, { id: 16, name: 'KIVANÃ‡ EFE ERGÃ–NÃœL', number: '21070005027' }, { id: 17, name: 'OÄUZ KOYUCAN', number: '21070005030' }, { id: 18, name: 'ZEYNEP ARSLANBUÄA', number: '21070005042' }, { id: 19, name: 'BESTE TEKÄ°N', number: '21070007001' }, { id: 20, name: 'EKÄ°N ALTUNKAYA', number: '21070007004' }, { id: 21, name: 'EMRE ERÄ°ÅÄ°R', number: '21070008003' }, { id: 22, name: 'Ä°SMAÄ°L CANBERK DEMÄ°RKAN', number: '21070008014' }, { id: 23, name: 'CAN GÄ°RGÄ°N', number: '21070008016' }, { id: 24, name: 'KEREM EROÄLU', number: '21070008017' }, { id: 25, name: 'ARMAÄAN SOYLU', number: '21070008027' }, { id: 26, name: 'ALP SERKAN MERKÄ°T', number: '21070008033' }, { id: 27, name: 'ATAKAN DÄ°NÃ‡ER', number: '21070008034' }, { id: 28, name: 'DEMET BÃœYÃœKTAÅ', number: '21070008306' }, { id: 29, name: 'GÃœRKAN EROÄLU', number: '22070001041' }, { id: 30, name: 'EMRE EFE YÃœKSEL', number: '22070001055' }, { id: 31, name: 'SÃœLEYMAN BATU SARI', number: '22070002015' }, { id: 32, name: 'KADÄ°R EMRE GÃœNEÅ', number: '22070002047' }, { id: 33, name: 'TOPRAK TUNCER', number: '22070005040' }, { id: 34, name: 'EMRE CAN HEKÄ°MOÄLU', number: '22070005053' }, { id: 35, name: 'ILGAR ÅENOL', number: '22070007014' }, { id: 36, name: 'EDA NUR Ã‡ALIÅKAN', number: '22070008017' }, { id: 37, name: 'SAMÄ° BERK ÅAHÄ°N', number: '22070008021' }, { id: 38, name: 'DENÄ°Z ÃœNVER', number: '22070008026' }, { id: 39, name: 'AYKAN KANLI', number: '22070008034' }, { id: 40, name: 'DENÄ°Z KARATEPE', number: '22070008043' }, { id: 41, name: 'AYÅEGÃœL KARINYARICI', number: '22070003022' }, { id: 42, name: 'AHMET Ã–ZGÃœR KORKMAZ', number: '21070001046' },
            ]),
            currentWeek: ls.get('ys_week', 1),
            attendance: ls.get('ys_attendance', {}),
            activeTab: 'dashboard',
            session: null,
            uiError: ''
        };

        // --- YARDIMCI FONKSÄ°YONLAR ---
        const getStatusInfo = (absences) => {
            if (absences >= 5) return { text: 'KALDI', color: 'bg-red-500/20 text-red-400' };
            if (absences === 4) return { text: 'TEHLÄ°KEDE', color: 'bg-orange-500/20 text-orange-400' };
            if (absences >= 2) return { text: 'DÄ°KKAT', color: 'bg-yellow-500/20 text-yellow-400' };
            return { text: 'GÃœVENLÄ°', color: 'bg-green-500/20 text-green-400' };
        };

        const getComputedStudents = () => {
            const weeks = Object.keys(state.attendance).map(Number);
            const maxWeek = weeks.length ? Math.max(...weeks) : 0;
            const presentMap = new Map();
            weeks.forEach(w => { (state.attendance[w] || []).forEach(n => { presentMap.set(n, (presentMap.get(n) || 0) + 1); }); });
            return state.students.map(s => {
                const present = presentMap.get(s.number) || 0;
                const absences = Math.max(0, maxWeek - present);
                return { ...s, present, absences, totalWeeks: maxWeek };
            });
        };

        const getCheckinURL = () => {
            const { origin, pathname } = window.location;
            const base = origin + pathname.replace(/\/$/, '') + '#/checkin';
            const code = state.session?.code || '';
            return `${base}?week=${state.currentWeek}&code=${encodeURIComponent(code)}`;
        };

        // --- HTML ÅABLONLARI (TEMPLATE) ---
        // Her bir sayfa veya bileÅŸen iÃ§in HTML Ã¼reten fonksiyonlar
        
        function renderDashboard() {
            const computedStudents = getComputedStudents();
            return `
                <div class="space-y-6 fade-in">
                    <div class="bg-black/20 p-6 rounded-lg border border-white/10">
                        <h2 class="text-xl font-bold text-white mb-4">Yeni Ã–ÄŸrenci Ekle</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input id="new-student-name" type="text" placeholder="Ad Soyad" class="flex-1 px-4 py-3 bg-gray-900/50 border border-white/20 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none transition" />
                            <input id="new-student-number" type="text" placeholder="Ã–ÄŸrenci No" class="flex-1 px-4 py-3 bg-gray-900/50 border border-white/20 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none transition" />
                            <button data-action="add-student" class="px-8 py-3 rounded-lg font-semibold text-white bg-gradient-to-r from-cyan-500 to-blue-500 hover:opacity-90 transition shadow-md flex items-center justify-center gap-2">
                                <i data-lucide="plus"></i> Ekle
                            </button>
                        </div>
                    </div>

                    <div class="bg-black/20 p-6 rounded-lg border border-white/10">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">Ã–ÄŸrenci Listesi</h2>
                            <div class="text-gray-400">Toplam: <span class="font-bold text-cyan-400">${state.students.length}</span> Ã¶ÄŸrenci</div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="border-b border-white/10">
                                    <tr>
                                        ${['Ad Soyad', 'Ã–ÄŸrenci No', 'Devam', 'Durum', 'Bu Hafta', 'Ä°ÅŸlem'].map(h => `<th class="px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-400 ${['Devam', 'Durum', 'Bu Hafta', 'Ä°ÅŸlem'].includes(h) ? 'text-center' : ''}">${h}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/10">
                                    ${computedStudents.map(s => {
                                        const { text, color } = getStatusInfo(s.absences);
                                        const isPresent = (state.attendance[state.currentWeek] || []).includes(s.number);
                                        return `
                                            <tr class="hover:bg-white/5 transition">
                                                <td class="px-4 py-4 font-medium text-gray-200 text-sm">${s.name}</td>
                                                <td class="px-4 py-4 text-gray-400 text-sm font-mono">${s.number}</td>
                                                <td class="px-4 py-4 text-center"><span class="text-xl sm:text-2xl font-bold text-cyan-400">${s.present}</span> <span class="text-gray-500 text-sm">/ ${s.totalWeeks || 0}</span></td>
                                                <td class="px-4 py-4 text-center"><span class="px-3 py-1 rounded-full font-bold text-xs sm:text-sm ${color}">${text}</span></td>
                                                <td class="px-4 py-4 text-center">${isPresent ? '<i data-lucide="check-circle" class="inline text-green-400"></i>' : '<i data-lucide="x-circle" class="inline text-gray-600"></i>'}</td>
                                                <td class="px-4 py-4 text-center"><button data-action="delete-student" data-id="${s.id}" class="text-red-500 hover:text-red-400 transition" title="Sil"><i data-lucide="trash-2" class="pointer-events-none"></i></button></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                        <div class="flex flex-wrap items-center justify-center gap-4">
                            <button data-action="prev-week" ${state.currentWeek === 1 ? 'disabled' : ''} class="bg-white/10 text-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-white/20 transition disabled:opacity-50 disabled:cursor-not-allowed">â† Ã–nceki</button>
                            <div class="text-xl font-bold text-white">Hafta ${state.currentWeek}</div>
                            <button data-action="next-week" ${state.currentWeek === 14 ? 'disabled' : ''} class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">Sonraki â†’</button>
                            <button data-action="download-csv" class="border border-cyan-500 text-cyan-500 px-6 py-3 rounded-lg font-semibold hover:bg-cyan-500/10 transition flex items-center gap-2"><i data-lucide="download"></i> CSV Ä°ndir</button>
                        </div>
                    </div>
                    ${state.uiError ? `<div class="bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg p-4"><b>Hata:</b> ${state.uiError}</div>` : ''}
                </div>
            `;
        }

        function renderQRPage() {
            const checkinURL = getCheckinURL();
            return `
                <div class="bg-black/20 p-8 rounded-lg border border-white/10 fade-in">
                    <h2 class="text-3xl font-bold text-white mb-6 text-center">QR Kod OluÅŸturucu</h2>
                    <div class="max-w-md mx-auto">
                        <div class="bg-gray-900/50 p-8 mb-6 rounded-xl border border-white/10 text-center">
                            <div class="text-6xl font-bold bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text text-transparent mb-2">Hafta ${state.currentWeek}</div>
                            <div class="text-gray-400">Yoklama oturumunu baÅŸlatÄ±n veya sonlandÄ±rÄ±n.</div>
                            ${!state.session?.active ? `
                                <button data-action="generate-qr" class="w-full mt-6 bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-4 rounded-xl text-lg font-bold hover:opacity-90 transition shadow-lg flex items-center justify-center gap-3"><i data-lucide="qr-code"></i> QR OluÅŸtur ve BaÅŸlat</button>
                            ` : `
                                <button data-action="deactivate-session" class="w-full mt-6 bg-gradient-to-r from-red-500 to-orange-500 text-white py-4 rounded-xl text-lg font-bold hover:opacity-90 transition shadow-lg">Oturumu Kapat</button>
                            `}
                        </div>

                        <div id="qr-display-area" class="qr-placeholder ${state.session?.active ? 'h-auto opacity-100' : 'h-0 opacity-0 overflow-hidden'}">
                            <div class="bg-gray-900/50 border-2 border-cyan-500 rounded-2xl p-8 text-center">
                                <div id="qrcode-container" class="inline-block bg-white p-4 rounded-xl shadow-2xl mb-4"></div>
                                <div class="mb-4">
                                    <div class="text-sm text-gray-400 mb-1">Oturum Kodu:</div>
                                    <div class="text-3xl font-mono font-bold text-cyan-300 break-all">${state.session?.code || ''}</div>
                                </div>
                                <div class="mt-4 flex flex-wrap gap-2 justify-center">
                                    <button data-action="copy-link" data-url="${checkinURL}" class="px-4 py-2 rounded-lg border-2 border-cyan-500 text-cyan-500 font-semibold hover:bg-cyan-500/20 transition">Linki Kopyala</button>
                                    <a href="${checkinURL}" target="_blank" class="px-4 py-2 rounded-lg bg-cyan-500 text-white font-semibold hover:bg-cyan-600 transition">Yeni Sekmede AÃ§</a>
                                </div>
                                ${BACKEND.mode === 'LOCAL' ? `<div class="mt-6 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl text-left text-sm text-yellow-300"><i data-lucide="alert-circle" class="inline mr-2"></i><b>Not:</b> LOCAL modda veriler sadece bu cihazda kalÄ±r. PaylaÅŸÄ±m iÃ§in 'KÄ±lavuz' sekmesine gÃ¶z atÄ±n.</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGuidePage() {
            return `
                <div class="bg-black/20 p-8 rounded-lg border border-white/10 fade-in">
                    <h2 class="text-3xl font-bold text-white mb-8 text-center">ğŸš€ KÄ±lavuz: Cihazlar ArasÄ± Ã‡alÄ±ÅŸtÄ±rma</h2>
                    <div class="space-y-6 max-w-4xl mx-auto text-gray-300">
                        <div class="bg-gray-900/50 rounded-xl p-6 border-l-4 border-cyan-500">
                             <h3 class="text-xl font-bold text-white mb-3">1) Vercel/Netlify ile YayÄ±nla (Kolay Yol)</h3>
                             <p>Bu projeyi Vercel veya Netlify gibi bir servise deploy ederseniz, Ã¶ÄŸrenciler kendi cihazlarÄ±ndan oluÅŸturulan linke eriÅŸebilir. \`LOCAL\` modda bile Ã§alÄ±ÅŸÄ±r, ancak veriler sizin tarayÄ±cÄ±nÄ±z yerine deploy edilen sunucunun \`localStorage\`'Ä±nda tutulur.</p>
                         </div>
                         <div class="bg-gray-900/50 rounded-xl p-6 border-l-4 border-green-500">
                             <h3 class="text-xl font-bold text-white mb-3">2) Google Apps Script ile PaylaÅŸÄ±mlÄ± KayÄ±t (Ã–nerilen)</h3>
                             <p class="mb-3">TÃ¼m cihazlarÄ±n veriyi merkezi bir Google E-Tablosu'na yazÄ±p okumasÄ±nÄ± saÄŸlar.</p>
                             <ol class="list-decimal list-inside space-y-2 mb-4">
                                 <li>Google Drive â†’ Yeni â†’ DiÄŸer â†’ <b>Apps Script</b>'e gidin.</li>
                                 <li>Yeni bir Google E-Tablosu oluÅŸturun ve ID'sini (URL'deki uzun karakter dizisi) kopyalayÄ±n.</li>
                                 <li>AÅŸaÄŸÄ±daki kodu Apps Script editÃ¶rÃ¼ne yapÄ±ÅŸtÄ±rÄ±n.</li>
                                 <li>\`YOUR_SHEET_ID_HERE\` yazan yeri kendi E-Tablo ID'nizle deÄŸiÅŸtirin.</li>
                                 <li><b>DaÄŸÄ±t</b> â†’ <b>Yeni DaÄŸÄ±tÄ±m</b>'Ä± seÃ§in. TÃ¼rÃ¼ "Web UygulamasÄ±" yapÄ±n ve eriÅŸimi "Herkes" olarak ayarlayÄ±n.</li>
                                 <li>DaÄŸÄ±tÄ±mdan aldÄ±ÄŸÄ±nÄ±z Web App URL'sini kopyalayÄ±p bu kodun en Ã¼stÃ¼ndeki \`BACKEND.APPS_SCRIPT_URL\` kÄ±smÄ±na yapÄ±ÅŸtÄ±rÄ±n ve \`mode\`'u \`'APPS_SCRIPT'\` olarak deÄŸiÅŸtirin.</li>
                             </ol>
<pre class="overflow-auto text-xs bg-gray-900 text-cyan-300 p-4 rounded-lg font-mono">
function doGet(e){const week=e.parameter.week;const action=e.parameter.action;const sheet=spread();if(action=='getSession'){const r=getRow(sheet,'sessions',week);return ContentService.createTextOutput(r?JSON.stringify(r):'null').setMimeType(ContentService.MimeType.JSON);}if(action=='getAttendance'){return ContentService.createTextOutput(JSON.stringify(getAll(sheet,'attendance'))).setMimeType(ContentService.MimeType.JSON);}return ContentService.createTextOutput('ok');}
function doPost(e){const body=JSON.parse(e.postData.contents);const sheet=spread();if(body.action=='saveSession'){put(sheet,'sessions',body.week,body.session);return json({ok:true});}if(body.action=='recordCheckin'){const s=get(sheet,'sessions',body.week);if(!s||!s.active||String(s.code).trim()!=String(body.code).trim())return json({ok:false,error:'Oturum aktif deÄŸil veya kod geÃ§ersiz.'});const att=get(sheet,'attendance',body.week)||[];if(att.includes(body.number))return json({ok:false,error:'Bu numara zaten yoklamaya katÄ±ldÄ±.'});att.push(body.number);put(sheet,'attendance',body.week,att);return json({ok:true});}return json({ok:false});}
function spread(){try{const ss=SpreadsheetApp.openById('YOUR_SHEET_ID_HERE');return ss.getSheetByName('data')||ss.insertSheet('data');}catch(e){throw new Error('SHEET_ID geÃ§ersiz veya eriÅŸim izni yok.');}}
function json(o){return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON)}
function getRow(sh,ns,key){const r=sh.getDataRange().getValues();for(let i=0;i<r.length;i++){if(String(r[i][0])==String(ns)&&String(r[i][1])==String(key))try{return JSON.parse(r[i][2])}catch(e){return r[i][2]}}return null}
function put(sh,ns,key,val){const r=sh.getDataRange().getValues();const strVal=JSON.stringify(val);for(let i=0;i<r.length;i++){if(String(r[i][0])==String(ns)&&String(r[i][1])==String(key)){sh.getRange(i+1,3).setValue(strVal);return}}sh.appendRow([ns,key,strVal])}
function get(sh,ns,key){return getRow(sh,ns,key)}
function getAll(sh,ns){const r=sh.getDataRange().getValues();const out={};for(let i=0;i<r.length;i++){if(r[i][0]==ns){try{const arr=JSON.parse(r[i][2]);out[r[i][1]]=arr}catch(e){}}}return out}
</pre>
                         </div>
                    </div>
                </div>
            `;
        }

        function renderMainLayout(content) {
            return `
                <div class="min-h-screen p-4 sm:p-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-96 h-96 bg-cyan-500/30 rounded-full filter blur-3xl opacity-50 animate-blob"></div>
                    <div class="absolute top-0 right-0 w-96 h-96 bg-purple-600/30 rounded-full filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>
                    <div class="absolute bottom-0 left-1/4 w-96 h-96 bg-pink-600/30 rounded-full filter blur-3xl opacity-50 animate-blob animation-delay-4000"></div>

                    <main class="max-w-7xl mx-auto bg-gray-900/50 backdrop-blur-xl rounded-2xl shadow-2xl p-6 sm:p-8 border border-white/10 relative z-10">
                        <header class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8">
                            <div class="text-center sm:text-left">
                                <h1 class="text-3xl sm:text-4xl font-bold text-white">Attendance System</h1>
                                <p class="text-gray-400">QR Code Based Smart Attendance</p>
                            </div>
                            <div class="text-center p-4 border border-white/10 rounded-xl bg-black/20">
                                <div class="text-5xl sm:text-6xl font-bold bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text text-transparent">${state.currentWeek}</div>
                                <div class="text-gray-400 tracking-widest">/ 14 WEEK</div>
                            </div>
                        </header>

                        <div class="bg-black/20 p-2 rounded-xl mb-6">
                            <div class="flex gap-2">
                                ${['dashboard', 'qr', 'guide'].map(tab => `
                                    <button data-action="set-tab" data-tab="${tab}" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 text-sm sm:text-base flex items-center justify-center gap-2 ${state.activeTab === tab ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-lg' : 'bg-white/5 hover:bg-white/10 text-gray-300'}">
                                        <i data-lucide="${tab === 'dashboard' ? 'users' : tab === 'qr' ? 'qr-code' : 'calendar'}"></i>
                                        <span class="capitalize">${tab === 'dashboard' ? 'Ã–ÄŸrenciler' : (tab === 'qr' ? 'QR Kod' : 'KÄ±lavuz')}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div id="tab-content">${content}</div>
                    </main>
                </div>
            `;
        }

        function renderCheckinPage(qs) {
            const week = qs.get('week') || '?';
            const code = qs.get('code') || 'GEÃ‡ERSÄ°Z';
            return `
                <div class="min-h-screen p-6 flex items-center justify-center relative overflow-hidden">
                    <div class="absolute top-1/4 left-0 w-96 h-96 bg-green-500/30 rounded-full filter blur-3xl opacity-50 animate-blob"></div>
                    <div class="absolute bottom-1/4 right-0 w-96 h-96 bg-teal-500/30 rounded-full filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>

                    <div class="w-full max-w-md relative z-10 fade-in">
                        <a href="#/dashboard" class="mb-4 flex items-center gap-2 text-cyan-400 hover:text-cyan-300 transition"><i data-lucide="arrow-left"></i> Ana Sisteme DÃ¶n</a>
                        <div class="bg-gray-900/50 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-white/10">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-2">ğŸ“²</div>
                                <h1 class="text-3xl font-bold text-white mb-2">Yoklama Check-in</h1>
                                <p class="text-gray-400">Hafta ${week}</p>
                            </div>
                            <div class="mb-6 p-4 rounded-xl bg-black/20 border border-white/10">
                                <div class="text-sm text-gray-400 mb-1">Oturum Kodu:</div>
                                <div class="font-mono text-2xl text-cyan-300 font-bold break-all">${code}</div>
                            </div>
                            <form id="checkin-form">
                                <label class="block text-sm font-semibold text-gray-300 mb-2">Ã–ÄŸrenci NumaranÄ±z</label>
                                <input name="number" type="tel" inputmode="numeric" placeholder="e.g., 21070008017" class="w-full px-4 py-4 bg-gray-900/50 border-2 border-white/20 rounded-xl text-lg focus:border-cyan-500 focus:ring-cyan-500/50 focus:outline-none mb-4 transition" />
                                <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-4 rounded-xl text-lg font-bold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">YoklamayÄ± Onayla</button>
                            </form>
                            <div id="checkin-message" class="mt-6"></div>
                            <div class="mt-6 p-4 bg-black/20 rounded-xl"><p class="text-xs text-gray-500 text-center">âš ï¸ LÃ¼tfen sadece kendi Ã¶ÄŸrenci numaranÄ±zÄ± girin.</p></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- ANA RENDER FONKSÄ°YONU ---
        // Sayfa durumuna gÃ¶re uygun HTML'i basar ve olaylarÄ± baÄŸlar
        async function render() {
            const hash = window.location.hash || '#/dashboard';
            const appContainer = $('#app-container');

            if (hash.startsWith('#/checkin')) {
                const qs = new URLSearchParams(hash.split('?')[1] || '');
                appContainer.innerHTML = renderCheckinPage(qs);
            } else {
                let content = '';
                if (state.activeTab === 'dashboard') content = renderDashboard();
                else if (state.activeTab === 'qr') content = renderQRPage();
                else if (state.activeTab === 'guide') content = renderGuidePage();
                appContainer.innerHTML = renderMainLayout(content);
                
                // QR kodu sadece QR sekmesindeyse ve oturum aktifse render et
                if(state.activeTab === 'qr' && state.session?.active) {
                    const qrContainer = $('#qrcode-container');
                    if (qrContainer) {
                        qrContainer.innerHTML = ''; // Ã–ncekini temizle
                        const typeNumber = 4;
                        const errorCorrectionLevel = 'L';
                        const qr = qrcode(typeNumber, errorCorrectionLevel);
                        qr.addData(getCheckinURL());
                        qr.make();
                        qrContainer.innerHTML = qr.createImgTag(5, 4);
                    }
                }
            }

            // Her render sonrasÄ± ikonlarÄ± oluÅŸtur
            lucide.createIcons();
        }

        // --- OLAY YÃ–NETÄ°MÄ° (EVENT HANDLING) ---
        async function handleAction(action, target) {
            state.uiError = ''; // Her eylemde hatayÄ± temizle

            if (action === 'set-tab') {
                state.activeTab = target.dataset.tab;
            }
            if (action === 'prev-week') {
                if (state.currentWeek > 1) {
                    state.currentWeek--;
                    ls.set('ys_week', state.currentWeek);
                    state.session = await api.getSession(state.currentWeek);
                }
            }
            if (action === 'next-week') {
                if (state.currentWeek < 14) {
                    state.currentWeek++;
                    ls.set('ys_week', state.currentWeek);
                    state.session = await api.getSession(state.currentWeek);
                }
            }
            if (action === 'add-student') {
                const name = $('#new-student-name').value.trim();
                const number = $('#new-student-number').value.trim();
                if (name && number) {
                    const newId = state.students.length ? Math.max(...state.students.map(s => s.id)) + 1 : 1;
                    state.students.push({ id: newId, name, number });
                    ls.set('ys_students', state.students);
                    $('#new-student-name').value = '';
                    $('#new-student-number').value = '';
                }
            }
            if (action === 'delete-student') {
                const studentId = parseInt(target.dataset.id, 10);
                if (confirm('Bu Ã¶ÄŸrenciyi silmek istediÄŸinizden emin misiniz?')) {
                    state.students = state.students.filter(s => s.id !== studentId);
                    ls.set('ys_students', state.students);
                }
            }
            if (action === 'generate-qr') {
                const code = Math.random().toString(36).substring(2, 10).toUpperCase();
                const newSession = { code, active: true, week: state.currentWeek, createdAt: Date.now() };
                await api.saveSession(state.currentWeek, newSession);
                state.session = newSession;
            }
            if (action === 'deactivate-session') {
                if (state.session) {
                    const closedSession = { ...state.session, active: false };
                    await api.saveSession(state.currentWeek, closedSession);
                    state.session = closedSession;
                }
            }
            if (action === 'copy-link') {
                try {
                    await navigator.clipboard.writeText(target.dataset.url);
                    alert('Link kopyalandÄ±!');
                } catch (err) {
                    alert('KopyalanamadÄ±.');
                }
            }
            if(action === 'download-csv') {
                const presentSet = new Set(state.attendance[state.currentWeek] || []);
                const rows = [['Hafta', 'Ad Soyad', 'Ã–ÄŸrenci No', 'Durum'], ...state.students.map(s => [state.currentWeek, s.name, s.number, presentSet.has(s.number) ? 'Var' : 'Yok'])];
                const csv = rows.map(r => r.map(x => /,|"/.test(String(x)) ? `"${String(x).replace(/"/g, '""')}"` : x).join(',')).join('\n');
                const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hafta_${state.currentWeek}_yoklama.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }

            render(); // Her eylemden sonra arayÃ¼zÃ¼ yeniden Ã§iz
        }
        
        // Ana olay dinleyicisi (Event Delegation)
        document.addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (actionTarget) {
                handleAction(actionTarget.dataset.action, actionTarget);
            }
        });
        
        document.addEventListener('submit', async (e) => {
            if (e.target.id === 'checkin-form') {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button');
                const messageDiv = $('#checkin-message');
                const numberInput = form.elements.number;
                
                button.disabled = true;
                button.textContent = 'Kontrol Ediliyor...';
                messageDiv.innerHTML = '';

                try {
                    const hash = window.location.hash || '';
                    const qs = new URLSearchParams(hash.split('?')[1] || '');
                    const week = qs.get('week');
                    const code = qs.get('code');
                    const number = numberInput.value;

                    if (!week || !code) throw new Error('GeÃ§ersiz baÄŸlantÄ±.');
                    if (!/^\d{11,}$/.test(number)) throw new Error('GeÃ§erli bir Ã¶ÄŸrenci numarasÄ± girin.');
                    
                    await api.recordCheckin(week, number, code);
                    
                    messageDiv.innerHTML = `<div class="p-4 rounded-xl text-sm font-medium border bg-green-500/10 text-green-300 border-green-500/20">âœ… YoklamanÄ±z baÅŸarÄ±yla alÄ±ndÄ±. TeÅŸekkÃ¼rler.</div>`;
                    numberInput.value = '';
                } catch (err) {
                    messageDiv.innerHTML = `<div class="p-4 rounded-xl text-sm font-medium border bg-red-500/10 text-red-300 border-red-500/20">âŒ Hata: ${err.message}</div>`;
                } finally {
                    button.disabled = false;
                    button.textContent = 'YoklamayÄ± Onayla';
                }
            }
        });


        // Rota deÄŸiÅŸtiÄŸinde (hash deÄŸiÅŸtiÄŸinde) yeniden render et
        window.addEventListener('hashchange', render);

        // --- UYGULAMAYI BAÅLAT ---
        async function init() {
            state.session = await api.getSession(state.currentWeek);
            render();
        }

        init();
    </script>
</body>
</html>
