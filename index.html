import React, { useEffect, useMemo, useState } from 'react';
import { AlertCircle, Users, Calendar, QrCode, Download, Plus, CheckCircle, X, ArrowLeft } from 'lucide-react';
import { QRCodeCanvas } from 'qrcode.react';

// --- İŞLEVSEL KOD (DEĞİŞİKLİK YOK) ---
// Bu kısım, uygulamanın mantığını içerir ve görselleştirmeden bağımsızdır.
// Hiçbir değişiklik yapılmamıştır.

const BACKEND = {
    mode: 'LOCAL', // 'LOCAL' | 'APPS_SCRIPT'
    APPS_SCRIPT_URL: ''
};
const ls = {
    get(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } },
    set(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch { } },
};
const api = {
    async saveSession(week, session) { if (BACKEND.mode === 'LOCAL') { const s = ls.get('ys_sessions', {}); s[week] = session; ls.set('ys_sessions', s); return session; } const r = await fetch(BACKEND.APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'saveSession', week, session }) }); if (!r.ok) throw new Error('Sunucuya yazılamadı'); return await r.json(); },
    async getSession(week) { if (BACKEND.mode === 'LOCAL') { const s = ls.get('ys_sessions', {}); return s[week] || null; } const u = new URL(BACKEND.APPS_SCRIPT_URL); u.searchParams.set('action', 'getSession'); u.searchParams.set('week', String(week)); const r = await fetch(u.toString()); if (!r.ok) throw new Error('Sunucudan oturum okunamadı'); return await r.json(); },
    async recordCheckin(week, number, code) { if (BACKEND.mode === 'LOCAL') { const s = ls.get('ys_sessions', {}); const sess = s[week]; if (!sess?.active) throw new Error('Oturum aktif değil.'); if (String(sess.code).trim() !== String(code).trim()) throw new Error('Kod doğrulanamadı.'); const a = ls.get('ys_attendance', {}); const c = new Set(a[week] || []); if (c.has(number)) throw new Error('Bu numara zaten yoklamaya katıldı.'); c.add(number); a[week] = Array.from(c); ls.set('ys_attendance', a); return { ok: true }; } const r = await fetch(BACKEND.APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'recordCheckin', week, number, code }) }); if (!r.ok) throw new Error('Sunucuya yazılamadı'); const d = await r.json(); if (!d?.ok) throw new Error(d?.error || 'Kayıt hatası'); return d; },
    async getAttendance() { if (BACKEND.mode === 'LOCAL') return ls.get('ys_attendance', {}); const u = new URL(BACKEND.APPS_SCRIPT_URL); u.searchParams.set('action', 'getAttendance'); const r = await fetch(u.toString()); if (!r.ok) throw new Error('Attendance okunamadı'); return await r.json(); }
};
function useRoute() { const [route, setRoute] = useState(() => window.location.hash || '#/dashboard'); useEffect(() => { const fn = () => setRoute(window.location.hash || '#/dashboard'); window.addEventListener('hashchange', fn); return () => window.removeEventListener('hashchange', fn); }, []); const hash = route.split('?')[0]; const qs = new URLSearchParams(route.split('?')[1] || ''); return { hash, qs }; }

// --- ANA UYGULAMA BİLEŞENİ (YENİ TASARIM) ---
export default function App() {
    const { hash, qs } = useRoute();
    const defaultStudents = [
        { id: 1, name: 'İBRAHİM GÜLTEKİN', number: '18070003013' }, { id: 2, name: 'ELİF EMİNE GÜNAL', number: '19070001053' }, { id: 3, name: 'ERK YANKI URAL', number: '19070008012' }, { id: 4, name: 'ERCE ÖZKAN', number: '20070001057' }, { id: 5, name: 'İPEK ATIŞ', number: '20070002048' }, { id: 6, name: 'İDİL ECE CEVAHİR', number: '20070007004' }, { id: 7, name: 'SUDE ONFİDAN', number: '20070008016' }, { id: 8, name: 'ÖMER ARICA', number: '20070008017' }, { id: 9, name: 'SELİM MERT KIRCAALİLİ', number: '20070008019' }, { id: 10, name: 'BERİL DERAN GÜRBÜZ', number: '20070008029' }, { id: 11, name: 'ALİ HAKTAN SIĞIN', number: '21070001004' }, { id: 12, name: 'ARDA ALTUNHAN', number: '21070001051' }, { id: 13, name: 'EKREM TEMEL', number: '21070001070' }, { id: 14, name: 'NESRİN ŞENTÜRK', number: '21070002005' }, { id: 15, name: 'BATUHAN ŞİŞMAN', number: '21070002025' }, { id: 16, name: 'KIVANÇ EFE ERGÖNÜL', number: '21070005027' }, { id: 17, name: 'OĞUZ KOYUCAN', number: '21070005030' }, { id: 18, name: 'ZEYNEP ARSLANBUĞA', number: '21070005042' }, { id: 19, name: 'BESTE TEKİN', number: '21070007001' }, { id: 20, name: 'EKİN ALTUNKAYA', number: '21070007004' }, { id: 21, name: 'EMRE ERİŞİR', number: '21070008003' }, { id: 22, name: 'İSMAİL CANBERK DEMİRKAN', number: '21070008014' }, { id: 23, name: 'CAN GİRGİN', number: '21070008016' }, { id: 24, name: 'KEREM EROĞLU', number: '21070008017' }, { id: 25, name: 'ARMAĞAN SOYLU', number: '21070008027' }, { id: 26, name: 'ALP SERKAN MERKİT', number: '21070008033' }, { id: 27, name: 'ATAKAN DİNÇER', number: '21070008034' }, { id: 28, name: 'DEMET BÜYÜKTAŞ', number: '21070008306' }, { id: 29, name: 'GÜRKAN EROĞLU', number: '22070001041' }, { id: 30, name: 'EMRE EFE YÜKSEL', number: '22070001055' }, { id: 31, name: 'SÜLEYMAN BATU SARI', number: '22070002015' }, { id: 32, name: 'KADİR EMRE GÜNEŞ', number: '22070002047' }, { id: 33, name: 'TOPRAK TUNCER', number: '22070005040' }, { id: 34, name: 'EMRE CAN HEKİMOĞLU', number: '22070005053' }, { id: 35, name: 'ILGAR ŞENOL', number: '22070007014' }, { id: 36, name: 'EDA NUR ÇALIŞKAN', number: '22070008017' }, { id: 37, name: 'SAMİ BERK ŞAHİN', number: '22070008021' }, { id: 38, name: 'DENİZ ÜNVER', number: '22070008026' }, { id: 39, name: 'AYKAN KANLI', number: '22070008034' }, { id: 40, name: 'DENİZ KARATEPE', number: '22070008043' }, { id: 41, name: 'AYŞEGÜL KARINYARICI', number: '22070003022' }, { id: 42, name: 'AHMET ÖZGÜR KORKMAZ', number: '21070001046' },
    ];

    const [students, setStudents] = useState(() => ls.get('ys_students', defaultStudents));
    const [currentWeek, setCurrentWeek] = useState(() => ls.get('ys_week', 1));
    const [activeTab, setActiveTab] = useState('dashboard');
    const [newStudent, setNewStudent] = useState({ name: '', number: '' });
    const [attendance, setAttendance] = useState(() => ls.get('ys_attendance', {}));
    const [session, setSession] = useState(null);
    const [qrCode, setQrCode] = useState('');
    const [uiError, setUiError] = useState('');

    useEffect(() => { ls.set('ys_students', students); }, [students]);
    useEffect(() => { ls.set('ys_week', currentWeek); }, [currentWeek]);
    useEffect(() => { ls.set('ys_attendance', attendance); }, [attendance]);

    useEffect(() => {
        const fetchSessionForWeek = async () => {
            try {
                setUiError('');
                const existingSession = await api.getSession(currentWeek);
                setSession(existingSession);
                if (existingSession?.active) {
                    setQrCode(existingSession.code);
                } else {
                    setQrCode('');
                }
            } catch (e) {
                setUiError(`Hafta ${currentWeek} oturum verisi alınamadı: ${e.message}`);
                setSession(null);
                setQrCode('');
            }
        };
        fetchSessionForWeek();
    }, [currentWeek]);

    const computedStudents = useMemo(() => {
        const weeks = Object.keys(attendance).map(Number);
        const maxWeek = weeks.length ? Math.max(...weeks) : 0;
        const presentMap = new Map();
        weeks.forEach(w => { (attendance[w] || []).forEach(n => { presentMap.set(n, (presentMap.get(n) || 0) + 1); }); });
        return students.map(s => {
            const present = presentMap.get(s.number) || 0;
            const absences = Math.max(0, maxWeek - present);
            return { ...s, present, absences, totalWeeks: maxWeek };
        });
    }, [students, attendance]);

    const getStatusInfo = (absences) => {
        if (absences >= 5) return { text: 'KALDI', color: 'bg-red-500/20 text-red-400' };
        if (absences === 4) return { text: 'TEHLİKEDE', color: 'bg-orange-500/20 text-orange-400' };
        if (absences >= 2) return { text: 'DİKKAT', color: 'bg-yellow-500/20 text-yellow-400' };
        return { text: 'GÜVENLİ', color: 'bg-green-500/20 text-green-400' };
    };

    const generateQR = async () => { try { setUiError(''); const code = Math.random().toString(36).substring(2, 10).toUpperCase(); setQrCode(code); const sess = { code, active: true, week: currentWeek, createdAt: Date.now() }; await api.saveSession(currentWeek, sess); setSession(sess); } catch (e) { setUiError(e.message || String(e)); } };
    const deactivateSession = async () => { try { const cur = await api.getSession(currentWeek); if (!cur) return; const closed = { ...cur, active: false }; await api.saveSession(currentWeek, closed); setSession(closed); setQrCode(''); } catch (e) { setUiError(e.message || String(e)); } };

    const checkinURL = useMemo(() => {
        const { origin, pathname } = window.location;
        const base = origin + pathname.replace(/\/$/, '') + '#/checkin';
        const code = qrCode || session?.code || '';
        return `${base}?week=${currentWeek}&code=${encodeURIComponent(code)}`;
    }, [currentWeek, qrCode, session]);

    const downloadCSV = () => { const presentSet = new Set(attendance[currentWeek] || []); const rows = [['Hafta', 'Ad Soyad', 'Öğrenci No', 'Durum'], ...students.map(s => [currentWeek, s.name, s.number, presentSet.has(s.number) ? 'Var' : 'Yok'])]; const csv = rows.map(r => r.map(x => /,|"/.test(String(x)) ? `"${String(x).replace(/"/g, '""')}"` : x).join(',')).join('\n'); const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `hafta_${currentWeek}_yoklama.csv`; a.click(); URL.revokeObjectURL(url); };

    if (hash === '#/checkin') {
        return <CheckinPage qs={qs} />;
    }

    return (
        <div className="min-h-screen bg-[#0d1117] text-gray-200 font-sans p-4 sm:p-8 relative overflow-hidden">
            {/* Arka Plan Işıkları */}
            <div className="absolute top-0 left-0 w-96 h-96 bg-cyan-500/30 rounded-full filter blur-3xl opacity-50 animate-blob"></div>
            <div className="absolute top-0 right-0 w-96 h-96 bg-purple-600/30 rounded-full filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>
            <div className="absolute bottom-0 left-1/4 w-96 h-96 bg-pink-600/30 rounded-full filter blur-3xl opacity-50 animate-blob animation-delay-4000"></div>

            <main className="max-w-7xl mx-auto bg-gray-900/50 backdrop-blur-xl rounded-2xl shadow-2xl p-6 sm:p-8 border border-white/10 relative z-10">
                {/* Üst Başlık */}
                <header className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8">
                    <div className="text-center sm:text-left">
                        <h1 className="text-3xl sm:text-4xl font-bold text-white">Attendance System</h1>
                        <p className="text-gray-400">QR Code Based Smart Attendance</p>
                    </div>
                    <div className="text-center p-4 border border-white/10 rounded-xl bg-black/20">
                        <div className="text-5xl sm:text-6xl font-bold bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text text-transparent">{currentWeek}</div>
                        <div className="text-gray-400 tracking-widest">/ 14 WEEK</div>
                    </div>
                </header>

                {/* Sekmeler */}
                <div className="bg-black/20 p-2 rounded-xl mb-6">
                    <div className="flex gap-2">
                        {['dashboard', 'qr', 'guide'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)}
                                className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 text-sm sm:text-base flex items-center justify-center gap-2 ${activeTab === tab ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-lg' : 'bg-white/5 hover:bg-white/10 text-gray-300'}`}>
                                {tab === 'dashboard' && <Users size={20} />}
                                {tab === 'qr' && <QrCode size={20} />}
                                {tab === 'guide' && <Calendar size={20} />}
                                <span className="capitalize">{tab === 'dashboard' ? 'Öğrenciler' : (tab === 'qr' ? 'QR Kod' : 'Kılavuz')}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* İçerik */}
                {activeTab === 'dashboard' && (
                    <div className="space-y-6">
                        <div className="bg-black/20 p-6 rounded-lg border border-white/10">
                            <h2 className="text-xl font-bold text-white mb-4">Yeni Öğrenci Ekle</h2>
                            <div className="flex flex-col sm:flex-row gap-4">
                                <input type="text" placeholder="Ad Soyad" value={newStudent.name} onChange={(e) => setNewStudent({ ...newStudent, name: e.target.value })} className="flex-1 px-4 py-3 bg-gray-900/50 border border-white/20 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none transition" />
                                <input type="text" placeholder="Öğrenci No" value={newStudent.number} onChange={(e) => setNewStudent({ ...newStudent, number: e.target.value })} className="flex-1 px-4 py-3 bg-gray-900/50 border border-white/20 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none transition" />
                                <button onClick={() => { if (!newStudent.name.trim() || !newStudent.number.trim()) return; const next = [...students, { id: students.length ? Math.max(...students.map(s => s.id)) + 1 : 1, name: newStudent.name.trim(), number: newStudent.number.trim() }]; setStudents(next); setNewStudent({ name: '', number: '' }); }}
                                    className="px-8 py-3 rounded-lg font-semibold text-white bg-gradient-to-r from-cyan-500 to-blue-500 hover:opacity-90 transition shadow-md flex items-center justify-center gap-2">
                                    <Plus size={20} /> Ekle
                                </button>
                            </div>
                        </div>

                        <div className="bg-black/20 p-6 rounded-lg border border-white/10">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-bold text-white">Öğrenci Listesi</h2>
                                <div className="text-gray-400">Toplam: <span className="font-bold text-cyan-400">{students.length}</span> öğrenci</div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="border-b border-white/10">
                                        <tr>
                                            {['Ad Soyad', 'Öğrenci No', 'Devam', 'Durum', 'Bu Hafta', 'İşlem'].map(h =>
                                                <th key={h} className={`px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-400 ${['Devam', 'Durum', 'Bu Hafta', 'İşlem'].includes(h) ? 'text-center' : ''}`}>{h}</th>
                                            )}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-white/10">
                                        {computedStudents.map((s) => {
                                            const { text, color } = getStatusInfo(s.absences);
                                            const isPresent = (attendance[currentWeek] || []).includes(s.number);
                                            return (
                                                <tr key={s.id} className="hover:bg-white/5 transition">
                                                    <td className="px-4 py-4 font-medium text-gray-200 text-sm">{s.name}</td>
                                                    <td className="px-4 py-4 text-gray-400 text-sm font-mono">{s.number}</td>
                                                    <td className="px-4 py-4 text-center"><span className="text-xl sm:text-2xl font-bold text-cyan-400">{s.present}</span> <span className="text-gray-500 text-sm">/ {s.totalWeeks || 0}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className={`px-3 py-1 rounded-full font-bold text-xs sm:text-sm ${color}`}>{text}</span></td>
                                                    <td className="px-4 py-4 text-center">{isPresent ? <CheckCircle className="inline text-green-400" size={20} /> : <X className="inline text-gray-600" size={20} />}</td>
                                                    <td className="px-4 py-4 text-center"><button onClick={() => { if (window.confirm('Bu öğrenciyi silmek istediğinizden emin misiniz?')) setStudents(students.filter(x => x.id !== s.id)); }} className="text-red-500 hover:text-red-400 transition" title="Sil"><X size={18} /></button></td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="bg-black/20 p-4 rounded-lg border border-white/10">
                            <div className="flex flex-wrap items-center justify-center gap-4">
                                <button onClick={() => setCurrentWeek(Math.max(1, currentWeek - 1))} disabled={currentWeek === 1} className="bg-white/10 text-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-white/20 transition disabled:opacity-50 disabled:cursor-not-allowed">← Önceki</button>
                                <div className="text-xl font-bold text-white">Hafta {currentWeek}</div>
                                <button onClick={() => setCurrentWeek(Math.min(14, currentWeek + 1))} disabled={currentWeek === 14} className="bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">Sonraki →</button>
                                <button onClick={downloadCSV} className="border border-cyan-500 text-cyan-500 px-6 py-3 rounded-lg font-semibold hover:bg-cyan-500/10 transition flex items-center gap-2"><Download size={18} /> CSV İndir</button>
                            </div>
                        </div>

                        {uiError && (<div className="bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg p-4"><b>Hata:</b> {uiError}</div>)}
                    </div>
                )}

                {activeTab === 'qr' && (
                    <div className="bg-black/20 p-8 rounded-lg border border-white/10">
                        <h2 className="text-3xl font-bold text-white mb-6 text-center">QR Kod Oluşturucu</h2>
                        <div className="max-w-md mx-auto">
                            <div className="bg-gray-900/50 p-8 mb-6 rounded-xl border border-white/10 text-center">
                                <div className="text-6xl font-bold bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text text-transparent mb-2">Hafta {currentWeek}</div>
                                <div className="text-gray-400">Yoklama oturumunu başlatın veya sonlandırın.</div>
                                {!session?.active ? (
                                    <button onClick={generateQR} className="w-full mt-6 bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-4 rounded-xl text-lg font-bold hover:opacity-90 transition shadow-lg flex items-center justify-center gap-3"><QrCode size={28} /> QR Oluştur ve Başlat</button>
                                ) : (
                                    <button onClick={deactivateSession} className="w-full mt-6 bg-gradient-to-r from-red-500 to-orange-500 text-white py-4 rounded-xl text-lg font-bold hover:opacity-90 transition shadow-lg">Oturumu Kapat</button>
                                )}
                            </div>

                            {session?.active && qrCode && (
                                <div className="bg-gray-900/50 border-2 border-cyan-500 rounded-2xl p-8 text-center animate-fade-in">
                                    <div className="inline-block bg-white p-4 rounded-xl shadow-2xl mb-4"><QRCodeCanvas value={checkinURL} size={220} includeMargin /></div>
                                    <div className="mb-4">
                                        <div className="text-sm text-gray-400 mb-1">Oturum Kodu:</div>
                                        <div className="text-3xl font-mono font-bold text-cyan-300 break-all">{qrCode}</div>
                                    </div>
                                    <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                        <button onClick={() => navigator.clipboard?.writeText(checkinURL)} className="px-4 py-2 rounded-lg border-2 border-cyan-500 text-cyan-500 font-semibold hover:bg-cyan-500/20 transition">Linki Kopyala</button>
                                        <button onClick={() => { try { window.open(checkinURL, '_blank', 'noopener'); } catch { } }} className="px-4 py-2 rounded-lg bg-cyan-500 text-white font-semibold hover:bg-cyan-600 transition">Yeni Sekmede Aç</button>
                                    </div>
                                    {BACKEND.mode === 'LOCAL' && (<div className="mt-6 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl text-left text-sm text-yellow-300"><AlertCircle className="inline mr-2" size={20} /><b>Not:</b> LOCAL modda veriler sadece bu cihazda kalır. Paylaşım için 'Kılavuz' sekmesine göz atın.</div>)}
                                </div>
                            )}
                        </div>
                    </div>
                )}
                 {activeTab === 'guide' && (
                    <div className="bg-black/20 p-8 rounded-lg border border-white/10">
                        <h2 className="text-3xl font-bold text-white mb-8 text-center">🚀 Kılavuz: Cihazlar Arası Çalıştırma</h2>
                        <div className="space-y-6 max-w-4xl mx-auto text-gray-300">
                            <div className="bg-gray-900/50 rounded-xl p-6 border-l-4 border-cyan-500">
                                <h3 className="text-xl font-bold text-white mb-3">1) Vercel/Netlify ile Yayınla (Kolay Yol)</h3>
                                <p>Bu projeyi Vercel veya Netlify gibi bir servise deploy ederseniz, öğrenciler kendi cihazlarından oluşturulan linke erişebilir. `LOCAL` modda bile çalışır, ancak veriler sizin tarayıcınız yerine deploy edilen sunucunun `localStorage`'ında tutulur.</p>
                            </div>
                            <div className="bg-gray-900/50 rounded-xl p-6 border-l-4 border-green-500">
                                <h3 className="text-xl font-bold text-white mb-3">2) Google Apps Script ile Paylaşımlı Kayıt (Önerilen)</h3>
                                <p className="mb-3">Tüm cihazların veriyi merkezi bir Google E-Tablosu'na yazıp okumasını sağlar.</p>
                                <ol className="list-decimal list-inside space-y-2 mb-4">
                                    <li>Google Drive → Yeni → Diğer → <b>Apps Script</b>'e gidin.</li>
                                    <li>Yeni bir Google E-Tablosu oluşturun ve ID'sini (URL'deki uzun karakter dizisi) kopyalayın.</li>
                                    <li>Aşağıdaki kodu Apps Script editörüne yapıştırın.</li>
                                    <li>`YOUR_SHEET_ID_HERE` yazan yeri kendi E-Tablo ID'nizle değiştirin.</li>
                                    <li><b>Dağıt</b> → <b>Yeni Dağıtım</b>'ı seçin. Türü "Web Uygulaması" yapın ve erişimi "Herkes" olarak ayarlayın.</li>
                                    <li>Dağıtımdan aldığınız Web App URL'sini kopyalayıp bu kodun en üstündeki `BACKEND.APPS_SCRIPT_URL` kısmına yapıştırın ve `mode`'u `'APPS_SCRIPT'` olarak değiştirin.</li>
                                </ol>
                                <pre className="overflow-auto text-xs bg-gray-900 text-cyan-300 p-4 rounded-lg font-mono">{`function doGet(e){const a=PropertiesService.getScriptProperties();const week=e.parameter.week;const action=e.parameter.action;const sheet=spread();if(action=='getSession'){const r=getRow(sheet,'sessions',week);return ContentService.createTextOutput(r?JSON.stringify(r):'null').setMimeType(ContentService.MimeType.JSON);}if(action=='getAttendance'){return ContentService.createTextOutput(JSON.stringify(getAll(sheet,'attendance'))).setMimeType(ContentService.MimeType.JSON);}return ContentService.createTextOutput('ok');}
function doPost(e){const body=JSON.parse(e.postData.contents);const sheet=spread();if(body.action=='saveSession'){put(sheet,'sessions',body.week,body.session);return json({ok:true});}if(body.action=='recordCheckin'){const s=get(sheet,'sessions',body.week);if(!s||!s.active||String(s.code).trim()!=String(body.code).trim())return json({ok:false,error:'Oturum aktif değil veya kod geçersiz.'});const att=get(sheet,'attendance',body.week)||[];if(att.includes(body.number))return json({ok:false,error:'Bu numara zaten yoklamaya katıldı.'});att.push(body.number);put(sheet,'attendance',body.week,att);return json({ok:true});}return json({ok:false});}
function spread(){try{const ss=SpreadsheetApp.openById('YOUR_SHEET_ID_HERE');return ss.getSheetByName('data')||ss.insertSheet('data');}catch(e){throw new Error('SHEET_ID geçersiz veya erişim izni yok.');}}
function json(o){return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON)}
function getRow(sh,ns,key){const r=sh.getDataRange().getValues();for(let i=0;i<r.length;i++){if(String(r[i][0])==String(ns)&&String(r[i][1])==String(key))try{return JSON.parse(r[i][2])}catch(e){return r[i][2]}}return null}
function put(sh,ns,key,val){const r=sh.getDataRange().getValues();const strVal=JSON.stringify(val);for(let i=0;i<r.length;i++){if(String(r[i][0])==String(ns)&&String(r[i][1])==String(key)){sh.getRange(i+1,3).setValue(strVal);return}}sh.appendRow([ns,key,strVal])}
function get(sh,ns,key){return getRow(sh,ns,key)}
function getAll(sh,ns){const r=sh.getDataRange().getValues();const out={};for(let i=0;i<r.length;i++){if(r[i][0]==ns){try{const arr=JSON.parse(r[i][2]);out[r[i][1]]=arr}catch(e){}}}return out}`}</pre>
                            </div>
                        </div>
                    </div>
                )}
            </main>
        </div>
    );
}

// --- CHECK-IN SAYFASI (YENİ TASARIM) ---
function CheckinPage({ qs }) {
    const week = qs.get('week');
    const code = qs.get('code');
    const [number, setNumber] = useState('');
    const [status, setStatus] = useState('idle');
    const [message, setMessage] = useState('');

    const submit = async (e) => {
        e.preventDefault();
        try {
            setStatus('checking'); setMessage('');
            if (!week || !code) throw new Error('Geçersiz bağlantı.');
            if (!/^\d{11,}$/.test(number)) throw new Error('Geçerli bir öğrenci numarası girin.');
            await api.recordCheckin(week, number, code);
            setStatus('ok'); setMessage('✅ Yoklamanız başarıyla alındı. Teşekkürler.'); setNumber('');
        } catch (e) {
            setStatus('err'); setMessage(`❌ Hata: ${e.message}` || 'Bilinmeyen bir hata oluştu.');
        }
    };

    return (
        <div className="min-h-screen bg-[#0d1117] text-gray-200 p-6 flex items-center justify-center relative overflow-hidden">
            <div className="absolute top-1/4 left-0 w-96 h-96 bg-green-500/30 rounded-full filter blur-3xl opacity-50 animate-blob"></div>
            <div className="absolute bottom-1/4 right-0 w-96 h-96 bg-teal-500/30 rounded-full filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>

            <div className="w-full max-w-md relative z-10">
                <button onClick={() => (window.location.hash = '#/dashboard')} className="mb-4 flex items-center gap-2 text-cyan-400 hover:text-cyan-300 transition"><ArrowLeft size={20} /> Ana Sisteme Dön</button>
                <div className="bg-gray-900/50 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-white/10">
                    <div className="text-center mb-6">
                        <div className="text-6xl mb-2">📲</div>
                        <h1 className="text-3xl font-bold text-white mb-2">Yoklama Check-in</h1>
                        <p className="text-gray-400">Hafta {week}</p>
                    </div>
                    <div className="mb-6 p-4 rounded-xl bg-black/20 border border-white/10">
                        <div className="text-sm text-gray-400 mb-1">Oturum Kodu:</div>
                        <div className="font-mono text-2xl text-cyan-300 font-bold break-all">{code}</div>
                    </div>
                    <form onSubmit={submit}>
                        <label className="block text-sm font-semibold text-gray-300 mb-2">Öğrenci Numaranız</label>
                        <input type="tel" inputMode="numeric" placeholder="e.g., 21070008017" value={number} onChange={(e) => setNumber(e.target.value.replace(/[^0-9]/g, ''))} className="w-full px-4 py-4 bg-gray-900/50 border-2 border-white/20 rounded-xl text-lg focus:border-cyan-500 focus:ring-cyan-500/50 focus:outline-none mb-4 transition" disabled={status === 'checking'} />
                        <button type="submit" disabled={status === 'checking' || !number} className="w-full bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-4 rounded-xl text-lg font-bold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">{status === 'checking' ? 'Kontrol Ediliyor…' : 'Yoklamayı Onayla'}</button>
                    </form>
                    {message && (<div className={`mt-6 p-4 rounded-xl text-sm font-medium border ${status === 'ok' ? 'bg-green-500/10 text-green-300 border-green-500/20' : 'bg-red-500/10 text-red-300 border-red-500/20'}`}>{message}</div>)}
                    <div className="mt-6 p-4 bg-black/20 rounded-xl"><p className="text-xs text-gray-500 text-center">⚠️ Lütfen sadece kendi öğrenci numaranızı girin. Başkası adına yoklama almak sistem tarafından kaydedilmektedir.</p></div>
                </div>
            </div>
        </div>
    );
}
